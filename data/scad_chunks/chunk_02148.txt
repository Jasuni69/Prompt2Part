module pbox(type) { //! Generate the STL for the main case
    height = pbox_height(type);
    total_height = pbox_total_height(type);
    top_thickness = pbox_top(type);
    wall = pbox_wall(type);
    ledge_outset = pbox_ridges(type).y;
    ledge_inset = base_outset - base_overlap;
    ledge_h = pbox_base(type) ? (ledge_outset - ledge_inset) * 2 : 0;

    stl(pbox_name(type))
        difference() {
            union() {
                linear_extrude(total_height)
                    pbox_outer_shape(type);

                if($children > 2)
                    children(2);
            }
            difference() {
                translate_z(top_thickness)
                    union() {
                        linear_extrude(height + eps)
                             offset(-wall / 2) pbox_mid_shape(type);

                         translate_z(height)                                     // Recess for the base
                            linear_extrude(total_height - height)
                                offset(base_outset)
                                    pbox_inner_shape(type);
                    }
                // Ledge to support the lid
                if(ledge_h)
                    translate_z(top_thickness + height - ledge_h)
                        difference() {
                            rounded_rectangle([pbox_width(type) + 2 * outset, pbox_depth(type) + 2 * outset, ledge_h], 1);

                            hull() {
                                linear_extrude(ledge_h + eps)
                                    offset(ledge_inset)
                                        pbox_inner_shape(type);

                                linear_extrude(eps)
                                    offset(ledge_outset)
                                         pbox_inner_shape(type);
                            }
                            pbox_screw_positions(type)
                                insert_hole(pbox_insert(type));
                        }

                // Corner lugs for inserts
                outset = wall + pbox_ridges(type).y;
                or = pbox_radius(type) + outset;
                inset = pbox_screw_inset(type) + outset;
                br = insert_boss_radius(pbox_insert(type), wall);
                ext = sqrt(2) * inset - or * (sqrt(2) - 1) - br;
                translate_z(height + top_thickness)
                    pbox_screw_positions(type)
                        insert_lug(pbox_insert(type), wall, counter_bore = 0, extension = ext, corner_r = or);

                if($children > 0)
                    children(0);
            }
            if($children > 1)
                children(1);
        }
}