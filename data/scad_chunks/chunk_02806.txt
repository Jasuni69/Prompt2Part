module outward_bevel_extrude(height=1,bevel,bevel_top,bevel_bottom)
{
  epsilon = 0.001;

  bothbev   = is_undef(bevel)        ? 0 : bevel;
  topbev    = is_undef(bevel_top)    ? bothbev : bevel_top;
  bottombev = is_undef(bevel_bottom) ? bothbev : bevel_bottom;
  
  // Extrude the whole shape for the total height.
  linear_extrude(height)
    children();

  if(bottombev > 0)
    translate([0,0,bottombev])
      mirror([0,0,1])
        make_bevel(bottombev)
          children();
  
  if(topbev > 0)
    translate([0,0,height-topbev])
      make_bevel(topbev)
        children();

  module make_bevel(bev)
  {
    // A negative shape is used.
    // The angle for roof() is 45 degrees,
    // therefor the original shape is made
    // larger with the amount of the height
    // of the bevel.
    // That is used for the negative shape.
    difference()
    {
      linear_extrude(bev,convexity=2)
        offset(delta=bev+epsilon)
          children();

      // Calculate the roof() over the
      // negative shape.
      // Lower it a little to be sure
      // that the difference removes
      // all of it.
      translate([0,0,-epsilon])
      roof(convexity=4)
        difference()
        {
          offset(delta=2*bev+epsilon)
            children();
          children();
        }
    }
  }
}


// ==============================================================
// Route the roof() to either a fake roof for old versions
// of OpenSCAD or call the new roof() function.